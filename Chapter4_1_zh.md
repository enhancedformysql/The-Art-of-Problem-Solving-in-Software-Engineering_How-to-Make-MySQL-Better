# 4.1 系统架构

系统架构定义了软件或硬件系统的高层结构,详细说明其组件、它们之间的相互关系以及它们如何协作以实现系统目标。

## 4.1.1 SMP

在 SMP(对称多处理)系统中,多个紧密耦合的处理器共享所有资源,如总线、内存和 I/O 系统。这种架构促进了所有 CPU 对内存、外围设备和操作系统的平等访问,没有区别,强调处理器之间共享资源的利用。

以下是典型的 SMP 架构图。

![](media/b2810b869602f1a37d43ed871c038020.png)

图 4-1. 典型的 SMP 架构。

在这种设置中,访问本地 L1 和 L2 缓存非常快,与 NUMA 架构相比,CPU 切换的开销很小。SMP 架构通常在正常条件下支持适度的吞吐量。然而,正是 SMP 无法有效扩展以满足更高吞吐量需求的问题导致了 NUMA 架构的发展。

## 4.1.2 NUMA

在多核系统日益增多的时代,内存层次结构正在向非均匀分布式架构演变。非均匀内存架构(NUMA)系统与 SMP 对应系统相比提供了卓越的可扩展性,其特点是分布在整个系统中的多个内存节点。每个节点在物理上与核心子集相邻,但所有节点的整个物理地址空间是全局可见的,允许核心本地或远程访问内存。因此,数据访问时间是非均匀的,并根据数据位置而变化。如果许多核心远程访问大量数据,从远程节点访问数据可能会由于延迟和互连争用而导致性能下降。这些问题可以通过尽可能将线程与其数据共同定位来缓解,这由 NUMA 感知调度算法促进。

跨芯片互连的吞吐量通常低于片上内存控制器的吞吐量。穿越此互连的远程内存访问也会经历比本地内存访问更高的延迟。由于其内存接口的多样性,这些多处理器被归类为 NUMA 系统。远程内存访问的性能影响可能很大;在当前实现中,NUMA 因子可能导致某些应用程序速度减慢多达 2 倍。

NUMA 节点在同一物理服务器内互连。当 CPU 需要访问远程内存时,它会产生等待时间。这种限制是 NUMA 服务器难以实现随着 CPU 增加而线性性能扩展的根本原因 [52]。

这是 NUMA 的经典架构图。

![](media/73a26c9835141996aa0470f756f95344.png)

图 4-2. 典型的 NUMA 架构。

在同一 NUMA 节点内的访问可以与专门形式的 SMP 访问相比较,其效率主要来自 NUMA 节点内降低的 CPU 切换成本。然而,一个缺点是同一 NUMA 节点内的内存带宽可能很快成为瓶颈,限制可扩展性。在不同 NUMA 节点之间访问内存涉及更高的成本,但它提供了更大的总体内存带宽。在 NUMA 环境中有效管理内存访问构成重大挑战。

下图展示了不同并发级别下 TPC-C 测试的比较结果。深蓝色曲线显示了固定 NUMA 节点 0 进行的测试,而深红色曲线表示利用机器的所有 4 个 NUMA 节点进行的测试。测试采用了改进版本的 MySQL,使用 1000 个仓库运行,并使用广泛采用的读已提交事务隔离级别。

<img src="media/image-20240829082946033.png" alt="image-20240829082946033" style="zoom:150%;" />

图 4-3. SMP 与 NUMA 的性能比较。

在绑定 NUMA 节点 0 的场景中,吞吐量与并发度的曲线明显平滑。即使在高并发下,吞吐量也只有轻微下降,表明线程上下文切换成本低 [60]。然而,由于内存带宽的显著限制,吞吐量始终保持在 400,000 tpmC 以下,这是传统 SMP 架构的特征。

相比之下,当利用所有 NUMA 节点时,吞吐量曲线相对较差。这归因于跨 NUMA 节点访问时内存效率降低和上下文切换成本增加,导致吞吐量不太稳定。尽管如此,可扩展性得到了极大改善,与使用单个 NUMA 节点相比,峰值吞吐量增加了 123%。

使用 4 个 NUMA 节点不会导致四倍的吞吐量;相反,它大约是单个 NUMA 节点的 2.x 倍。这种非线性扩展是 NUMA 架构固有的,并且由于 MySQL 在线性可扩展性方面的挑战而加剧。

MySQL 在实现线性可扩展性方面的困难源于几个因素,包括基于 MVCC ReadView 的读已提交事务隔离机制。这涉及将全局 ReadView 复制到本地 ReadView,导致线程之间为全局 ReadView 更新而产生争用。此外,在 NUMA 环境中,需要频繁的跨 NUMA 节点访问,进一步使可扩展性复杂化。

许多代码不适合 NUMA 环境。例如,关键部分中的频繁锁存器争用可能导致频繁的跨 NUMA 节点上下文切换。关键部分内的慢速操作可能由于频繁的跨 NUMA 节点缓存迁移而导致程序执行效率低下。

要在 NUMA 系统上实现最佳性能 [4],以下策略至关重要:

1. 最大化路由到本地节点的内存访问比例。
2. 平衡跨节点和互连链路的流量。

内存请求的不平衡分布可能会显著增加过载控制器上的内存访问延迟,有时达到约 1000 个周期,而在非过载控制器上约为 200 个周期。

虽然 Microsoft SQL Server 和 Oracle DBMS 是 NUMA 感知的,但 MySQL 不是 [5]。因此,像 MySQL 这样缺乏 NUMA 感知的大规模应用程序在 NUMA 环境中提供了显著的优化潜力。

有趣的是,对于 MySQL,禁用 NUMA 可能会提高性能。根据第 2.9 节中的案例研究,在 BIOS 中禁用 NUMA 配置改善了 MySQL 主节点的性能。这种调整影响了内存分配策略,导致 NUMA 节点之间更一致的内存访问。这与上面提到的优化策略 2 一致,有利于 MySQL 的吞吐量和稳定性。

## 4.1.3 X86 架构

X86 使用一种称为 CISC(复杂指令集计算)的复杂系统。这可以同时执行许多任务,但使处理器更加复杂且创建成本更高。X86 架构允许与内存进行更直接的交互,促进了计算任务的深度,但代价是更高的功耗 [45]。总体而言,x86 具有更高的性能能力,非常适合要求苛刻的计算任务。

对于使用 x86 架构的主流 NUMA 机器,请参见下图以分析特定机器上不同 NUMA 节点之间的内存访问开销:

![](media/9d907772570668253e631c9235ac2623.png)

图 4-4. 典型 x86 架构中的节点距离。

从图中可以明显看出,在 x86 架构下,访问本地节点的开销为 10 个单位,访问远程 NUMA 节点的开销为 21 个单位。以下是改进的 MySQL 8.0.27 使用 BenchmarkSQL 的 TPC-C 测试结果:

<img src="media/image-20240829083025561.png" alt="image-20240829083025561" style="zoom:150%;" />

图 4-5. 典型 x86 架构中不同 NUMA 绑定下的性能比较。

在 x86 架构下,每增加一个 NUMA 节点,高并发吞吐量都会显著增加。这突出了 x86 架构在有效管理跨 NUMA 节点内存访问方面的强大性能能力,从而充分利用其高性能计算的全部潜力。

## 4.1.4 ARM 架构

历史上,ARM 处理器优先考虑功率效率,在移动系统市场占主导地位,而 x86 处理器在高性能计算方面处于领先地位。ARM 和 x86 处理器之间的主要区别在于它们的指令集:ARM 使用 RISC(精简指令集计算)架构,该架构简化指令以提高速度和能源效率。这种简单性使 ARM 成为智能手机等电池供电设备的理想选择 [47]。相比之下,x86 采用 CISC(复杂指令集计算)架构,支持更广泛的复杂操作,但通常消耗更多功率。

关于内存处理,ARM 处理器专注于基于寄存器的处理,以最小化直接内存访问,从而提高能源效率。相比之下,x86 架构允许与内存进行更直接的交互,能够执行更广泛的计算任务,但代价是更高的功耗。基于 ARM 架构的服务器以其低功耗和成本效益而闻名。然而,与 x86 架构相比,它们通常表现出较低的整体性能,并且在内存访问可扩展性方面可能存在限制。

对于使用 ARM 架构的主流 NUMA 机器,请参见下图以观察特定机器上不同 NUMA 节点之间的内存访问开销:

![](media/da82a95da8f5e01d5de56f221c22d65c.png)

图 4-6. 典型 ARM 架构中的节点距离。

与 x86 架构相比,ARM 架构下不同 NUMA 节点之间的内存访问开销明显更复杂且差异显著。

以下是在 ARM 机器上的测试结果,使用与 x86 机器上类似的 MySQL 代码和配置,设置大致相同,包括 1000 个仓库。

<img src="media/image-20240829083106816.png" alt="image-20240829083106816" style="zoom:150%;" />

图 4-7. 典型 ARM 架构中不同 NUMA 绑定下的性能比较。

从图中可以明显看出,绑定 NUMA 节点 0 和 1 显著提高了吞吐量。然而,添加 NUMA 节点 2 并没有明显提高吞吐量,主要是由于 ARM 架构固有的 NUMA 节点距离。广泛的测试表明,与 ARM 相比,MySQL 在 x86 架构上表现出更好的可扩展性。

[下一页](Chapter4_2_zh.md)
