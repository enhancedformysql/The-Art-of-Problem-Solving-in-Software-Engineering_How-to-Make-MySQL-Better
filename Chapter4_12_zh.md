## 4.12 软件测试

### 4.12.1 测试对 MySQL 开发人员的重要性

对于 MySQL 开发人员来说，测试和开发是不可分割的。由于 MySQL 的内部机制复杂，外部测试人员通常难以掌握其逻辑，通常只能进行黑盒测试。鉴于 MySQL 的复杂性，通常需要尽可能多的测试用例来减少回归测试的工作量。因此，MySQL 开发人员需要了解如何有效利用测试用例来测试自己的程序。

### 4.12.2 平衡测试用例和开发效率

并非每个问题都需要设计测试用例；有时，设计测试用例的复杂性超过了修复代码的复杂性。例如，对于 MySQL 内基于 Paxos 的通信，没有特定的测试用例，主要依赖开发人员进行广泛的手动测试。

测试用例设计的原则应该是在成本合理的情况下提供测试用例，在成本过高的情况下避免它们。有效平衡这种关系可以提高开发效率。

值得注意的是，Group Replication 的测试用例被发现过于宽松，导致重构后的回归测试面临重大挑战。过多和宽松的测试用例会消耗大量开发时间，使得很难确定问题是出在测试用例本身还是重构的代码上。

### 4.12.3 确保测试环境的一致性

测试结果可能会因各种环境因素而波动，需要一致的环境以确保公平性。SSD 的引入显著减少了 MySQL 的 I/O 等待时间；然而，如果在测试期间未监控 SSD 性能下降，结果可能会偏离预期。使用诸如 ***fstrim -a*** 之类的命令可以减轻 SSD 降级效果，确保测试受影响较小。

Linux 操作系统利用 I/O 缓存，这可能导致测试结果的可变性，特别是在测试之间的间隔很长时。因此，建议最小化两次测试之间的时间间隔，并重复初始测试以评估波动。如果很显著，测试结果可能会变得无效。

在本书中，通常使用 BenchmarkSQL 或 SysBench 等测试工具。BenchmarkSQL 会随着时间的推移增加数据量，因此为了公平性和性能的可比性，测试在数据库重构后开始，以确保结果的可重复性。

### 4.12.4 如何高效测试？

最有效的测试方法是直接利用真实的在线流量进行评估。然而，这对于数据库来说可能太冒险了。更安全的方法是将在线流量复制到专用测试环境中。

在 Oracle 中，Database Replay 使用真实的生产工作负载测试系统，帮助在对生产系统实施更改之前识别潜在问题。任何工作负载期间都可以以很少的开销捕获，并用于驱动测试系统，保持真实工作负载的并发和负载特性。保持这些特性至关重要，因为当前的测试解决方案通常缺乏基于数据依赖性的同步。没有适当的同步，工作负载无法按要求执行，导致覆盖率差和负载不足，使许多问题未被发现。Database Replay 基于数据的同步使测试真实，并有助于发现潜在问题[34]。

在 MySQL 中，一种常见的策略涉及将 MySQL 从实例脱机进行测试，配置必要的集群，并将在线 MySQL 请求复制到这个新的测试主节点。测试主节点越接近生产环境，测试结果就越准确。有多种方法可以复制在线 MySQL 请求。本书推荐开源工具 TCPCopy[65]。通过使用 [TCPCopy]([TCP Handshake & TCPCopy Replication Animation](https://enhancedformysql.github.io/animation/how_tcpcopy_works.html))，许多在线问题已成功有效地解决，为 MySQL 代理增强奠定了坚实的基础[66]。为了测试 MySQL 集群，使用 TCPCopy 将在线请求复制到测试系统，使我们能够评估修改是否达到预期结果，例如性能改进和鲁棒性。

### 4.12.5 测试是关于发现问题还是验证问题？

测试不仅用于验证已知问题，还用于发现新问题。验证问题是确保软件按预期行为的初始步骤。随后，重点转移到积极发现程序中的潜在问题，抢在测试人员发现它们之前。在改进 MySQL 的过程中采用这种策略从根本上确保了 MySQL 修改的质量。实践经验验证了这种方法非常有效。在可能的情况下，复制在线流量进行测试提供了一种强大的方法来识别软件中的潜在问题，进一步增强其整体质量。

[下一页](Chapter5_zh.md)
