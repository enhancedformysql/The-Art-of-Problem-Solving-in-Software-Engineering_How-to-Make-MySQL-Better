# 第3章：如何有效解决软件问题

当遇到具有挑战性的问题时,软件专业人员通常依靠经验来寻找解决方案。然而,特别是对于本书中讨论的众多 MySQL 问题,仅凭经验识别问题的根本原因是具有挑战性的。因此,需要科学的方法来分析和解决这些问题。

本章从两个不同的层面讨论如何分析和解决问题:策略和战术 [1]。

## 3.1 分析策略

有许多分析策略,包括心理策略、简化策略、模式查找策略、增加可重现性的策略以及查找关键证据的策略。

### 3.1.1 心理策略

许多人经常感到被问题所压倒,特别是当问题看起来神秘或难以解决时。当他们遇到这样的挑战时,如果无法自己解决,第一反应往往是向他人寻求帮助。然而,仅仅依赖他人可能会妨碍通过解决问题来发展和加强自己的逻辑思维能力的机会。

当面对困难时,特别是那些看起来复杂的困难时,以自信的态度来处理它们至关重要。这些挑战可以作为释放个人潜力和提高解决问题能力的机会。MySQL 作为一个复杂的数据库软件,呈现出许多这样的挑战。

首先,随着时间的推移,遇到这些挑战会导致对 MySQL 的更深入理解。其次,它们提供了宝贵的机会来解决复杂问题,从而提高开发人员的问题解决能力。最后,与 MySQL 相关的历史问题是无价的;没有它们,像这样的书就不会存在。每个挑战都有助于扩展我们的知识库并完善我们解决 MySQL 相关问题的方法。

### 3.1.2 简化策略

当问题发生并且重现原始条件非常复杂时,必须逐步简化重现环境。这种方法允许您检查问题是否仍然发生。如果是,您继续简化,直到问题不再表现出来。这种策略显著简化了问题分析的难度。例如,在排查 MySQL 集群的问题时,首先检查问题是否在单个 MySQL 实例上发生。如果是,就不需要设置整个集群;您可以使用单个实例进行故障排查。

### 3.1.3 模式查找策略

当问题重现时,它经常揭示潜在的特征,便于与其相关的模式和规律的统计聚合。这些数据支持问题重现和推理。例如,在应用 PGO 后,峰值性能没有增加反而下降了。在各种并发级别下的测试显示,在高并发下显著下降,在较低级别下观察到改进。这一见解为解决后续问题奠定了基础,并强化了 PGO 在高并发场景中改进吞吐量潜力的信心。

### 3.1.4 增加可重现性的策略

许多问题是特定于环境的,通常零星出现,特别是在高并发下。挑战在于解决这些不频繁的发生,可能每隔几个月才发生一次。将问题重现的频率增加——从每隔几个月到每隔几个小时或几分钟——显著简化了它们的解决。

如何实现这一点?捕获问题发生的模式至关重要。例如,在解决 Group Replication 中零星冻结视图的同时失败时,分析统计模式揭示了关键见解。这些问题通常聚集在特定阈值周围。调整较低级别的通信超时设置以与网络中断持续时间对齐,可以更频繁地重现问题。一旦理解了这些关键因素,重现问题的可能性就会显著增加,为有效解决问题奠定坚实的基础。

因此,重现问题的能力通常在解决具有挑战性的问题中被证明是至关重要的。通过捕获问题重现的特征来提高可重现性是加快问题解决的关键。

### 3.1.5 查找关键证据的策略

有时,直接揭示问题的特征是具有挑战性的;它需要创造条件来充分表现问题。让我们重新审视下面的图,以 PGO 为例。

<img src="media/image-20240829082635337.png" alt="image-20240829082635337" style="zoom:150%;" />

图 3-1. MySQL 8.0.27 中使用 PGO 前后的性能比较测试。

PGO(配置文件引导优化)在低并发下有效改进吞吐量。然而,有强烈的信念认为,高并发场景中其他因素的干扰限制了 PGO 实现其预期效果的能力。

基于上述分析,将 MySQL 实例绑定到 NUMA 节点 0 使我们能够探索 PGO 是否可以在 SMP 环境中实现其性能潜力。有关具体的比较测试结果,请参见下图:

<img src="media/image-20240829082659498.png" alt="image-20240829082659498" style="zoom:150%;" />

图 3-2. SMP 下 MySQL 8.0.27 中使用 PGO 前后的性能比较测试。

从图中可以看出,绑定到单个 NUMA 节点表明 PGO 在所有显示的并发场景中都显著改进了性能。这一发现强调了 PGO 提升 MySQL 吞吐量的能力,为改进 NUMA 环境中的性能建立了坚实的基础。

关于第 2.4 节中讨论的 TPC-C 吞吐量急剧下降,用户在升级到 MySQL 8.0.29 后的回归测试中遇到了这个问题。值得注意的是,这种性能下降在 MySQL 8.0.25 中是不存在的。用户对这一差异的反馈至关重要,极大地促进了解决过程。

## 3.2 逻辑思维

编程的核心在于解决问题。逻辑推理使程序员能够将复杂的问题分解为可管理的组件,并通过分析需求、理解元素之间的关系以及进行逻辑和高效的规划来设计实用的解决方案。这种结构化的方法使程序员能够进行批判性思考和创造性创新 [56]。逻辑推理在计算机工程中对于创建合理的推论至关重要。在工作场所增强使用逻辑思维可以通过完善决策制定和最大限度地减少错误来提高生产力。逻辑植根于顺序思考,支撑着编程中所有系统分析、解决方案设计、错误纠正和性能优化。它利用演绎、归纳、溯因推理和反证法来收集关键证据、识别矛盾并确保软件可靠性。

### 3.2.1 演绎推理

演绎推理涉及从前提推导结论,通常结构为三段论。三段论通常包括大前提、小前提和结论。例如:

- 大前提:所有集群数据库都无法同时满足 CAP(一致性、可用性和分区容错性)的三个要求。
- 小前提:Group Replication 是一种集群数据库。
- 结论:因此,Group Replication 也无法满足 CAP 的三个要求。

鉴于 Group Replication 无法满足这些要求,应该根据用户的具体需求来选择它,而不是试图满足所有标准。

这里是另一个例子:

- 大前提:异步网络系统难以区分慢响应和系统故障。
- 小前提:TCP 通信依赖于异步网络。
- 结论:因此,TCP 通信系统也遇到区分慢响应和实际系统故障的挑战。

由于这些挑战,TCP 设计必须包含特定的功能,例如强大的超时机制和对幂等性的支持。

### 3.2.2 归纳推理

归纳推理从特定实例推断到一般结论。例如:

- 在 x86 NUMA 平台上,原生 MySQL 8.0.32 在读已提交隔离级别下显示出较差的可扩展性。
- 在 ARM NUMA 平台上,原生 MySQL 8.0.32 同样在读已提交隔离级别下显示出较差的可扩展性。

因此,在各种 NUMA 平台上,原生 MySQL 8.0.32 在读已提交隔离级别下始终表现出较差的可扩展性。归纳推理对于问题分析至关重要,并在各种应用中具有实际意义。

### 3.2.3 溯因推理

溯因推理,也称为逆向推理,涉及从观察到的事实推导最佳解释。这是解决编程问题中广泛采用的方法,特别是当症状明显但潜在原因不清楚时。例如,在使用 PGO(配置文件引导优化)优化 MySQL 后,如果吞吐量峰值下降而不是增加,溯因推理可能会揭示 MySQL 在 NUMA 环境中的处理不当正在导致这一结果。

### 3.2.4 反证法

"反证法"是一种通过证明其逻辑结论导致荒谬或矛盾的结果来反驳命题的方法。这种方法旨在表明一个陈述或假设必须是错误的,因为接受它会导致不合逻辑或不可接受的结果。这是一种常用的反驳论证的方法,其特点是"*以退为进*"的策略,引入荒谬性暴露推理中的缺陷。

例如,Group Replication 经常报告网络不可达错误。为了验证这些错误消息的可靠性,可以认为它们是准确的。然而,在受控的 localhost 环境中部署 Group Replication,在不需要外部网络访问的情况下,不应该导致相同的网络错误。然而,在正常的 TPC-C 数据加载过程中,频繁的网络不可达错误仍然存在。这种不一致表明错误消息不可靠。

### 3.2.5 综合运用各种方法

软件问题解决中的挑战与数学问题中的挑战有很大不同,通常受到人类误判和众多外部因素的影响,导致判断中频繁出现错误。这个领域的理论基础相对不发达,增加了问题解决的复杂性。

利用逻辑思维方法对于解决复杂的编程问题至关重要。这些方法通常需要综合多种方法来解决挑战,有时还需要结合概率信息。

## 3.3 解决问题的战术

策略本身很少直接解决问题;需要更强大的方法来解决它们。

### 3.3.1 平衡不同选项

一旦确定了问题的根本原因,通常有多个选项可供选择,需要仔细权衡它们的利弊。例如,在解决 InnoDB 与 NUMA 的兼容性不佳时,有两种解决方案:第一种是无锁存器修改,这很复杂、容易出错且维护成本高;第二种是提高访问关键锁存器资源的速度,这是一个更简单的解决方案,但不是最终的解决方案,因为它在极高并发下仍然表现出问题。鉴于在修改期间需要保持与 MySQL 官方版本的兼容性,选择了第二个选项,这是一个明智的决定。至于高并发下的可扩展性问题,实施事务节流机制可以改进性能,达到与无锁存器解决方案相当的水平。

### 3.3.2 分解问题

复杂的问题通常带来多个相关问题,这些问题可能会严重干扰分析和判断。为了有效解决此类问题,消除这些干扰、简化问题并最大限度地减少误判风险至关重要。例如,在优化 Group Replication 中的 Paxos 算法时,事先解决其他性能问题对于准确评估 Paxos 算法优化的影响至关重要。

一旦消除了所有干扰,如果核心问题仍然过于复杂,则需要进一步分解它。下图显示了 redo log 优化的一个例子:

![](media/685ea4b1fb85f093764bbaa58e13347d.png)

图 3-3. redo log 优化的官方工作日志描述。

为了解决 redo log 的可扩展性问题,开发人员已将此问题细分为以下子问题:

![](media/5502725fcc5648f2f6d18aaf68832505.gif)

图 3-4. redo log 优化的官方工作日志要求。

这涉及无锁存器并发写入日志缓冲区、用于处理写入和刷新过程的专用线程等等。

### 3.3.3 通过探索寻找解决方案

当面对不熟悉的问题或被过多细节所淹没时,必须在探索的同时寻求解决方案。这种方法对于解决复杂问题特别有效。例如,在我们优化 Paxos 算法期间,我们最初只有一个基本的优化概念,许多细节尚未考虑。在这个阶段,我们需要通过遇到的挑战来测试和完善我们的解决方案,最终逐步实现我们的优化目标。

### 3.3.4 寻求理论支持

在增强 Group Replication 的过程中,植根于状态机复制(SMR)理论,首先通过彻底的论文审查获得大量理论知识至关重要。这种方法培养了更深入的理解,并在整个增强过程中保持清晰,确保对概念的全面掌握,防止偏离预期路径。

《设计数据密集型应用》一书很好地讨论了理论,具体如下 [28]:

*尽管理论论文和证明并不总是容易理解,有时会做出不切实际的假设,但它们对于这个领域的实际工作来说是非常有价值的:它们帮助我们推理什么可以做,什么不能做,并帮助我们找到分布式系统经常出现缺陷的违反直觉的方式。如果您有时间,这些参考文献非常值得探索。*

值得一提的是,本书包含大量的学术材料作为演绎推理和理论支持的基础。

### 3.3.5 基于逻辑的测试

要评估新功能的性能改进潜力,需要在各种角度和环境中进行严格的迭代测试和验证。可靠的结论确保后续测试中的可预测结果。在验证期间观察到的任何偏差都必须彻底调查,以确定潜在的干扰因素。

例如,考虑线程池机制对性能的影响,特别是在高并发测试条件下。之前在 MySQL 5.7 上的验证表明线程池显著改进了吞吐量。然而,MySQL 8.0 中的后续修改揭示了不同的情况。第 2.3 章中的案例研究表明 Percona 线程池对可扩展性产生负面影响。MySQL 的官方技术博客报告称,随着时间的推移,线程池的有效性下降了 [31]。

<img src="media/image-thread-pool.png" alt="image-thread-pool" style="zoom:150%;" />

在进行性能比较测试时,消除人为错误(如环境或配置的变化)至关重要。为了缓解这个问题,重复初始测试并将其结果与第一次测试的结果进行比较可以帮助识别重大变化。如果没有明显的差异,这表明中间测试相对可靠。例如,加入一个额外的测试,如下图所示,以比较其与初始测试的性能差异。

<img src="media/image-20240829082837729.png" alt="image-20240829082837729" style="zoom:150%;" />

图 3-5. 用于比较与初始测试的性能差异的额外测试。

重复初始测试可以显著缓解测试不确定性和环境污染的问题。然而,仅此还不够;还需要解释每次测试的任何异常结果。如果无法提供解释并且问题是可重现的,这通常呈现出一个新的优化机会。

例如,在 TPC-C 测试期间,观察到吞吐量异常,后来发现是由于省略了使用 jemalloc。发现不使用 jemalloc 的性能实际上更好。广泛的测试发现 MySQL 的 jemalloc 3.6 并未提供最佳性能,促使探索替代的 jemalloc 版本。这些测试强调了内存分配工具对整体性能的重大影响。

## 3.4 逻辑推理的原则

以下是逻辑推理的原则 [15],可以为如何进行逻辑推理提供一些帮助:

```
1.  在接受结论之前先询问理由,
2.  给出一个论证来支持你的结论,
3.  设计你的理由以暗示结论,
4.  认识到拥有更多相关信息的价值,
5.  权衡利弊,
6.  考虑可能的行动方案,
7.  查看这些不同行动方案的后果,
8.  评估后果,
9.  考虑这些不同后果实际发生的概率,
10. 在实际可行时推迟做出重要决定,
11. 根据情况评估所说的内容,
12. 在得出结论时使用你的背景知识和常识,
13. 记住非凡的陈述需要非凡的证据,
14. 遵从专家的意见,
15. 记住更坚定的结论需要更好的理由,
16. 在自己的推理中保持一致,
17. 警惕自己和他人推理中的不一致,
18. 检查解释是否符合所有相关事实,
19. 你可以通过表明存在尚未排除的替代解释来使对手的解释更不可信,
20. 紧扣主题,
21. 在获得足够的证据之前不要得出结论。
```

## 3.5 逻辑推理:解决复杂问题的关键

许多复杂的软件问题源于信息和逻辑的混乱。要解决这些问题,通过精确的数据和系统推理来澄清逻辑关系以追溯根本原因至关重要。利用这种逻辑方法可以显著增强程序员的问题解决技能。

虽然数据结构和算法是编程的核心,但解决编程问题不仅仅是熟悉或精通它们。它需要逻辑推理技能。因此,本章的内容为后续主题奠定了基础。

## 3.6 解决难题与做练习题的区别

在做练习时,通常会提供必要的信息,允许学生应用教科书知识和逻辑推理来找到解决方案。这个过程有助于培养解决问题的技能。然而,进入工作场所并面对真正的编程挑战时,个人往往感到措手不及。学校很少教授如何处理像 MySQL 这样的程序中的复杂问题,使初学者感到困惑,不知道从哪里开始或如何找到必要的信息。

复杂的问题可能会让程序员感觉好像他们遇到了超自然现象,特别是当他们获得的信息是矛盾或误导性的时候。在实践中,解决具有挑战性的编程问题与解决练习题有明显不同。即使是熟练的团队也可能花费数月时间筛选分散注意力的信息以确定根本原因,这可能导致越来越沮丧。

解决练习题和解决现实世界问题之间的主要相似之处是逻辑推理。区别在于信息的可获得性:练习题预先提供必要的细节,而现实世界的问题需要推理来揭示关键的、通常被掩盖的信息。这个过程涉及辨别真伪、过滤干扰并识别真正相关的条件以进行有效的问题解决。

在许多情况下,获取关键问题解决信息的难度远远超过解决问题本身的挑战。

## 3.7 常见的问题解决框架

在软件行业中,面对问题时,最初的本能往往是检查其他人是否遇到过类似的问题。然而,在问题解决过程中,个人经常依靠个人经验来提出解决方案,有时没有坚实的基础。怀疑可能指向网络故障或配置问题,促使采取各种可能只是暂时缓解问题而不解决其根本原因的行动。提问者和解决者都经常优先考虑快速修复,可能忽视了逻辑推理的关键作用。

考虑一个现实生活中的场景:一位 DBA 进行 MySQL 性能测试发现吞吐量不稳定且较低。他们提供了有关 CPU、内存和配置的详细信息,注意到具有显著脏页活动的线程级 IO,但省略了特定的 IO 设备信息。关于网络问题的推测通过 DBA 进行的测试被驳回。关于自旋延迟配置的建议同样被驳回。这种推测性的方法被证明是低效的,未能揭示潜在的问题。

专业的问题解决需要基于观察到的现象的逻辑推理,以系统地缩小问题的范围。这涉及分析不同并发级别下的使用模式,尝试在不同机器类型上复现问题,以及审查过去的软件版本是否存在类似问题。这些见解有助于精确的逻辑推理。

回到 DBA 的案例研究,在高规格机器上绑定 NUMA 节点调整了 CPU 和内存资源以匹配用户的硬件规格,同时保持高规格磁盘。测试随后表明吞吐量显著改善且稳定。最终,关键问题被精确定位到 IO 设备的差异。这种方法有效地识别了根本原因,而不是仅仅依赖于经验或推测方法。

有效的软件问题解决依赖于逻辑推理。下面是一个说明常见问题解决框架的图。

![](media/8fdf25878c4aff269ad26bc3002e7205.png)

图 3-6. 解决程序问题的通用框架。

该图整合了逻辑推理和信息检索。保持逻辑思维确保每一步的可靠性。没有它,就有可能陷入阻碍有效软件问题解决的陷阱。

[下一页](Chapter4_zh.md)
