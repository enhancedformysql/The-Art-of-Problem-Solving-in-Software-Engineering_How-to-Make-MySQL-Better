# 第6章：如何科学地测试MySQL性能？

性能基准测试通常用于在科学文献和工业出版物中比较不同的系统或算法。尽管性能测量看起来似乎是客观的，但各种因素可能会有意或无意地影响基准测试结果，使其偏向于某一系统。在性能基准测试中存在根本的利益冲突，特别是在对先前版本或竞争对手的系统进行评估时。一些结果通常被称为"基准营销"（benchmarketing），会歪曲性能数据。公平的性能基准测试是具有挑战性的，很容易歪曲数据，无论是意外还是故意[9]。

本书探讨了MySQL性能基准测试中的常见陷阱，并描述了如何避免它们以确保公平的性能比较。

## 6.1 常见陷阱

本节讨论在进行性能比较时遇到的常见陷阱。

### 6.1.1 不可复现性

可复现性是科学研究的基石，允许他人验证结果并识别错误。没有可复现性，实验中的主张和数字就无法得到验证。与大型科学研究相比，进行可复现的实验相对简单且成本较低。然而，许多数据库研究论文由于闭源代码、未公开的数据或专有系统而缺乏可复现性。

为了实现可复现性，必须提供所有配置参数，包括操作系统、服务器安装、版本、设置和配置标志等细节。此外，应提供任何算法或实现的源代码[9]。

本书中的大多数测试将包括源代码、MySQL配置文件、测试工具详情、硬件规格和操作系统版本，以确保测试结果的可复现性和可验证性。

### 6.1.2 未能优化

基准测试通常用于比较系统或评估新算法的有效性。通常，实验涉及将新提出的系统与现有系统进行比较，以展示卓越的性能。

然而，这种设置可能会降低对现有系统进行适当优化的动力，因为当前系统的性能不佳可以使新系统看起来更好。对于依赖于正确配置的系统来说，这个问题尤为严重，因为配置不当的系统可能比配置良好的系统性能差得多。

针对特定工作负载优化DBMS是复杂的，通常需要专业知识。即使是小的优化也可以提高性能比较的公平性。遵循基准测试的优化指南或让被比较系统的代表参与也可以帮助获得更准确的结果[9]。

对于本书中的性能测试，应用了以下策略：

1. **进行优化前后比较：** 在可行的情况下，在优化前后进行性能比较，力求最小的变化。
2. **匹配配置参数：** 尽可能使配置参数与生产环境保持一致。
3. **在相同硬件上进行性能比较**：在相同的x86机器上在NUMA环境中以相同配置进行测试。重新初始化MySQL数据目录并清理SSD（通过TRIM）以避免干扰。跨一系列并发级别进行测试以评估吞吐量，并确定优化是否提高了性能或可扩展性。
4. **在NUMA节点绑定后重复测试**：在绑定到NUMA节点0后，重复测试以比较SMP环境中的性能。
5. **在禁用NUMA的x86机器上测试**：在具有相同硬件但禁用NUMA（在BIOS中）的x86机器上进行比较性能测试。
6. **在ARM机器上评估性能**：在具有类似MySQL配置的NUMA环境中的ARM机器上测试比较性能。
7. **使用不同工具验证一致性**：使用各种测试工具比较结果并确保一致性。例如，使用BenchmarkSQL和修改版本的tpcc-mysql进行TPC-C测试。
8. **评估不同网络延迟下的性能**：检查不同网络延迟条件下的性能影响。
9. **使用不同"思考时间"场景测试性能**：评估性能如何随不同"思考时间"场景而变化，以衡量一致性。
10. **进行闭环测试**：通过重复初始测试并将结果与第一轮进行比较，确保测试期间没有干扰。测试结果的小差异表明环境相对稳定。
11. **验证瓶颈干扰**：确认高并发下其他瓶颈的干扰是否扭曲了性能比较。
12. **分析理论基础和异常**：评估性能优化是否有理论基础，以及是否可以解释任何异常。分析优化类型、其一般适用性以及哪些环境受益最大。调查异常以确定其原因。

### 6.1.3 过度特定调优

这些问题可以通过进行超越标准化基准测试的一系列实验来缓解。虽然标准化基准测试提供了有用的基线，但一些系统可能针对它们进行了大量优化，降低了它们的比较有效性。因此，应测试和测量其他查询[9]。

为了解决这些问题，MySQL配置应满足以下标准：

1. **最小化配置参数的影响**：确保参数（如缓冲池大小）不妨碍其他优化。
2. **使用默认配置**：对不确定的参数（如自旋延迟）应用默认设置。
3. **匹配生产配置**：使测试设置与生产配置一致，例如sync_binlog=1和innodb_flush_log_at_trx_commit=1。

为了克服单一类型测试的局限性，采用各种测试场景。对于TPC-C，包括具有不同冲突严重程度、思考时间和网络延迟的测试。对于SysBench，使用Pareto分布、读写和纯写操作的测试。

这些策略确保在各种条件下对MySQL性能优化进行全面评估，从而获得更强大和可靠的结果。

### 6.1.4 冷运行与热运行

区分"热"运行和"冷"运行至关重要。冷运行发生在从持久存储加载相关数据和解析查询时，通常比数据已缓存的热运行慢。由于这些差异，冷运行和热运行的性能测量应分别记录和报告[9]。

对于TPC-C测试，所有测试操作都遵循标准化流程以确保一致性，并且测试在无人工干扰的环境中进行。此外，为了减轻不同环境造成的性能干扰，采用了闭环测试以尽可能最大化测试结果的可靠性。

### 6.1.5 冷运行与温运行

测量冷运行需要谨慎，以避免意外记录温运行。正确的测量不仅仅是重新启动数据库服务器并运行查询，因为操作系统可能会在内存中缓存数据。正确的方法是停止数据库服务器，清除所有操作系统缓存，重新启动服务器，然后运行查询。

进行了一项评估测试来评估这些影响。例如，下图比较了清除缓存前后的TPC-C吞吐量和并发性。

<img src="media/image-20240830214738439.png" alt="image-20240830214738439" style="zoom:150%;" />

图6-1. 清除缓存前后BenchmarkSQL测试的比较。

从图中可以观察到，清除缓存后的吞吐量确实低于之前的吞吐量。

为了减轻此类问题，采用了闭环测试，可以有效地检测环境中的异常。

### 6.1.6 人为错误

在评估新设计算法的性能时，验证实现的正确性至关重要，以避免忽视可能产生不正确结果的错误。错误可能导致性能指标基于错误的结果，可能使算法由于处理的数据较少等原因而看起来更高效。如果基准测试不可复现，这个问题会更加严重，因为不正确的实现可能会被错误地接受为有效。

此外，程序可能对特定数据集正确工作，但由于溢出处理不足或硬编码数据集属性等问题而在一般情况下失败。始终通过将输出与基准规范中的参考答案进行比较并检查不同数据的结果来验证程序产生正确的结果[9]。

对于性能测试，必须考虑优化结果是否受到其他因素的影响。例如，在使用CATS锁调度算法的MySQL 8.0中，性能评估可能会受到MySQL生成的大量死锁日志的影响。

## 6.2 综合测试

性能测试是一个极其复杂的过程。只有通过全面的测试和分析，才能最大限度地减少测试过程中的错误，从而科学地评估优化的价值。

### 6.2.1 使用多种工具测试

主要使用SysBench、BenchmarkSQL和修改版的tpcc-mysql工具进行测试。SysBench测试读写、纯写和Pareto分布场景。BenchmarkSQL用于跨各种并发级别的TPC-C测试。修改版的tpcc-mysql工具在极端条件下测试MySQL。

### 6.2.2 识别竞争密集型测试

访问相同数据的并发线程越多，竞争就越大。SysBench Pareto分布测试被认为是高竞争的，而SysBench均匀分布测试是低竞争的。在修改的BenchmarkSQL中，使用1000个仓库进行测试代表低竞争，而在相同并发级别下使用10个仓库进行测试表示高竞争。

### 6.2.3 理解TPC-C测试特性

TPC-C基准测试是研究和工业中数据库并发控制的黄金标准[25]。

实验设置可以显著影响评估结果。在TPC-C中：

- 引入等待时间使实验成为I/O密集型。
- 移除等待时间使实验成为CPU/内存密集型。
- 减少仓库数量使实验成为竞争密集型。

TPC-C可以压力测试计算机系统的几乎每个关键组件，但这种多功能性为不同系统之间的公平比较带来了挑战[8]。

在较高层面上，以下因素减少竞争：

- 更多仓库
- 更少跨仓库事务
- 每个仓库更少工作人员/用户
- 添加等待时间
- 关键部分内的短I/O或无I/O

在低竞争设置中，吞吐量受系统最慢组件的限制：

- 如果数据超过DRAM大小，则为磁盘I/O
- 如果使用传统TCP堆栈且数据适合DRAM，则为网络I/O
- 集中式序列器或全局依赖图也可能导致可扩展性瓶颈

相反，以下因素增加竞争：

- 更少仓库
- 更多跨仓库事务
- 每个仓库更多工作人员/用户
- 无等待时间
- 关键部分内的长I/O

在高竞争设置中，吞吐量由并发控制机制决定。能够更早释放锁或减少中止的系统将具有优势[8]。

下图显示了不同仓库数量的TPC-C吞吐量与并发性之间的关系。深蓝色曲线代表100个仓库，而深红色曲线代表1000个仓库。该图说明了100个仓库的吞吐量明显低于1000个仓库，因为前者场景中的竞争更严重。

<img src="media/image-20240829093518737.png" alt="image-20240829093518737" style="zoom:150%;" />

图6-2. 更多仓库表示竞争较不严重。

### 6.2.4 在测试中加入思考时间

TPC-C包括等待时间，模拟用户在每次事务之前使用键入和思考时间的行为。每个仓库有十个终端，每个区域一个，允许每个仓库最多十个并发事务。标准TPC-C不允许调整这些参数，除了仓库数量。

由于等待时间和每个仓库十个并发用户的限制，每个仓库的最大吞吐量是有限的。为了实现更高的吞吐量，必须使用许多仓库，这就是为什么像OceanBase和Oracle这样的系统使用数百万个仓库的原因。对于存储大量数据且每GB吞吐量低的工作负载，SSD可以比DRAM更经济地满足吞吐量要求，这与OceanBase和Oracle的硬件配置一致。因此，只要等待时间长且每个仓库的并发用户有限，标准TPC-C就是一个I/O密集型基准测试，竞争度低，因为同时访问的概率低。

大多数研究都涉及竞争，因此需要移除等待时间以获得每个仓库更高的吞吐量和竞争水平。使用更少的仓库来维持竞争。由于压力测试不同的系统组件，有无等待时间的TPC-C数字不可比较[8]。

下图显示了具有1ms思考时间（请求前的暂停）的TPC-C测试，说明了吞吐量与并发性的关系。

<img src="media/image-20240829093552414.png" alt="image-20240829093552414" style="zoom:150%;" />

图6-3. 1ms思考时间对吞吐量的影响。

从图中可以观察到，使用1ms思考时间时，峰值吞吐量在1000并发时达到，而在正常TPC-C测试中，峰值在250并发时达到。使用思考时间进行测试与常规BenchmarkSQL测试相比引入了显著差异，并且还要求MySQL具有更好的可扩展性。

### 6.2.5 I/O对测试的影响

功能齐全的数据库系统必须处理网络I/O以支持诸如2PC、数据复制或Paxos等协议，以及用于数据持久化的磁盘I/O。许多研究省略了这些I/O，引发了关于其影响的问题。

结果可能因硬件和实现而异，但通常，如果每个TPC-C事务只需要一个数据包，则TCP本身可以支持每秒数百万个事务。然而，添加诸如2PC和复制等协议会显著增加数据包需求。例如，标准Paxos复制到三个副本每个事务至少需要四个数据包，这可能会使TCP堆栈不堪重负，并成为高事务率的瓶颈。

网络和磁盘延迟也会影响竞争工作负载中的吞吐量。关键部分中较长的延迟会降低最大吞吐量，I/O延迟的影响更为显著。

然而，没有完美的解决方案：例如，RDMA涉及昂贵的硬件和复杂的软件，在地理分布式环境中并没有显著帮助[8]。

### 6.2.6 长期稳定性测试

根据TPC-C基准测试，数据库必须在稳定状态下运行八小时，并在性能收集阶段超过两小时。此外，基准测试要求数据库在两小时的测试中保持小于2%的抖动[14]。

为了在MySQL测试中满足这些稳定性要求，实施了以下措施：

1. 定期清理binlog以防止由于I/O空间限制导致的SSD性能下降。
2. 使用更多的仓库。
3. 添加索引。
4. 部署多个SSD。

遵循这些措施后，使用BenchmarkSQL进行了TPC-C测试。下图说明了MySQL 8.0.27和改进的MySQL 8.0.27之间的稳定性测试比较。

<img src="media/image-degrade2.png" alt="image-degrade2" style="zoom:150%;" />

图6-4. 稳定性测试比较：MySQL 8.0.27与改进的MySQL 8.0.27。

从图中可以明显看出，虽然MySQL和改进的MySQL开始时具有相似的吞吐量，但MySQL的吞吐量随时间下降的速度比预期的要快，而改进的MySQL保持明显更稳定。

此外，还对改进的MySQL在不同并发级别进行了比较。下图显示了随时间变化的吞吐量：深蓝色曲线代表100并发，而深红色曲线代表200并发。

<img src="media/image-degrade3.png" alt="image-degrade3" style="zoom:150%;" />

图6-5. 稳定性测试比较：100并发与200并发。

从图中可以观察到，在100并发时吞吐量更稳定。在200并发时，增加的数据处理导致吞吐量下降更快，因为单个服务器上更大的数据库规模导致访问时间变慢。

下图比较了在100和200并发级别完成8小时测试后MySQL数据库文件的大小。

<img src="media/image-20240829093934212.png" alt="image-20240829093934212" style="zoom:150%;" />

图6-6. 数据库大小比较：8小时后的100并发与200并发。

从图中可以明显看出，在200并发时，数据库大小明显大于100并发。通常，较高的吞吐量往往会降低稳定性，各种因素影响稳定性测试，使得广泛概括具有挑战性。

### 6.2.7 在线流量测试

性能测试往往无法反映真实世界的用例，并且通常报告的细节不足以进行复制或得出准确结论[39]。

TCPCopy [60]可以捕获生产工作负载并在测试系统上重放它，保留原始工作负载的确切时序、并发性和事务特性。这允许在不影响生产环境的情况下测试系统变更的影响。

下图说明了将MySQL流量从在线系统复制到MySQL测试系统的机制。

![](media/3103134e2713f196cd4bd4242ef79f8e.png)

图6-7. 将MySQL流量从生产系统复制到测试系统的机制。

测试真实世界的在线流量对MySQL至关重要，因为它有效地揭示了潜在的问题，如性能稳定性、内存泄漏和新MySQL版本的健壮性。

[下一页](Part3_zh.md)
