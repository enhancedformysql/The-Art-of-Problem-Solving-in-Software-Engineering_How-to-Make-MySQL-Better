## 4.7 计算机网络

计算机网络可以被视为计算机科学、计算机工程和电信的一个分支，因为它依赖于这些学科的理论和实践应用。该领域由众多技术发展和历史里程碑所塑造[45]。

在学校里,网络课程通常教授理论，但通常不会向学生展示如何实际分析和解决网络问题。因此，当问题出现时，许多人感到迷茫，缺乏有效解决问题所需的逻辑思维能力。虽然网络知识可以随时获取，但识别正确的问题解决方法需要大量实践。正确的方法确保问题顺利解决，而错误的方向会显著增加解决问题的难度。

本节讨论在网络环境中用于解决 MySQL 相关问题的常见理论、技术、网络分区和逻辑推理。

### 4.7.1 FLP 不可能定理

在具有潜在进程崩溃故障的完全异步消息传递分布式系统中，Fischer、Lynch 和 Paterson 在 1985 年提出的 FLP 不可能性结果证明，使用确定性算法实现共识是不可能的。然而，实践者通常忽略这一结果，因为真实系统通常表现出一定程度的同步性。FLP 结果假设的最坏情况调度场景在实践中不太可能发生，除非在对抗性情况下，如智能拒绝服务攻击[46]。

FLP 不可能定理在问题解决中很有价值，因为它突出了在网络中区分丢失消息和延迟消息的挑战。在实践中，虽然消息延迟通常是有界的，但 MySQL 等系统中的延迟可能会延长，这使得很难判断节点信息是丢失了还是仅仅是延迟了。这里的误判可能导致错误，例如 Group Replication 错误地报告节点不可达。

Group Replication 中使用的 Mencius 算法通过使用故障检测器预言机来绕过 FLP 不可能性结果。与 Paxos 一样，它仅依赖故障检测器来实现活性。Mencius 要求最终所有且仅有故障服务器被故障检测器怀疑。这可以通过实现具有指数增长超时的故障检测器来实现[32]。

为了避免由不确定性引起的问题，需要仔细设计。例如，TCP 通过超时重传和幂等设计来解决这个问题，确保即使由于传输错误收到重复消息，它们也可以安全地丢弃。

### 4.7.2 TCP/IP 协议栈

互联网协议套件，通常称为 TCP/IP，组织了互联网和类似计算机网络中使用的一组通信协议[45]。它提供端到端的数据通信，指定数据应如何分组、寻址、传输、路由和接收。该套件分为四个抽象层，每个层根据其网络范围对相关协议进行分类：

1. **链路层**：处理单个网络段（链路）内的通信。
2. **互联网层**：管理独立网络之间的互联。
3. **传输层**：促进主机到主机的通信。
4. **应用层**：为应用程序启用进程到进程的数据交换。

针对特定应用程序实现这些层形成协议栈。TCP/IP 协议栈是全球使用最广泛的协议栈之一，自设计以来已成功运行多年。下图说明了客户端程序如何使用 TCP/IP 协议栈与 MySQL 服务器交互。

![](media/5ae071ad7e34c7d0d6bc00f94811382f.png)

图 4-34. 客户端程序使用 TCP/IP 协议栈与 MySQL 服务器交互。

由于 TCP/IP 协议栈的分层设计，客户端程序通常只与本地 TCP 交互以访问远程 MySQL 服务器。这种设计在简洁性上非常优雅：

1. **客户端 TCP**：处理将 SQL 查询端到端发送到远程 MySQL 服务器。如果数据包丢失，它管理重传。
2. **服务器端 TCP**：从客户端 TCP 接收 SQL 查询并将其转发到 MySQL 服务器应用程序。处理后，通过其 TCP 栈发送响应。
3. **路由和转发**：TCP 使用 IP 层进行路由和转发，而 IP 层依赖数据链路层在同一网络段内进行物理传输。

虽然 TCP 确保可靠传输，但由于潜在的网络异常，它不能保证消息始终到达目的地。例如，SQL 请求可能被网络防火墙阻止，阻止它们到达 MySQL 服务器。在这种情况下，客户端应用程序可能不会收到响应，导致关于请求是否已处理或仍在传输中的不确定性。

为了解决这些问题，像数据包捕获这样的额外工具可以帮助确定 SQL 请求是否已到达 MySQL 服务器，从而澄清情况。

### 4.7.3 TCP 状态机

下图描述了用于 TCP 状态之间转换的经典 TCP 状态机。

![](media/ff831787f6acc1e38a7f70dc47925ee0.gif)

图 4-35. 经典 TCP 状态机概述。

灵活理解状态转换对于排除 MySQL 网络问题至关重要。例如：

- **CLOSE_WAIT 状态**：服务器上大量的 *CLOSE_WAIT* 状态表明应用程序没有及时关闭连接或未能启动关闭进程，导致连接停留在此状态。
- **SYN_RCVD 状态**：大量的 *SYN_RCVD* 状态可能表明 SYN 洪水攻击，其中过多的 SYN 请求超过了服务器有效处理它们的能力。

理解这些状态转换有助于更有效地诊断和解决网络相关问题。

### 4.7.4 网络传输过程中数据内容会被损坏吗？

许多分析 MySQL 网络问题的软件专业人员经常怀疑传输过程中数据损坏，导致对 TCP 可靠性的质疑。

在 TCP/IP 协议栈中，IP 网络是不可靠的，而 TCP 确保可靠性。TCP 如何确保对用户程序的可靠传输？有两种主要情况：数据包丢失和数据损坏。当面对 IP 网络中的数据包丢失时，TCP 采用称为超时和重传的机制。根据 FLP 不可能定理，即使中间设备引入延迟，重传的数据包（包括之前的数据包）也可能到达目的地。TCP 基于序列号和有效载荷长度实现接收信息的幂等性，有效解决了数据包丢失和延迟引起的问题。对于数据损坏，TCP 使用校验和验证。如果检测到差异，损坏的数据将被丢弃，发送方重传数据。

然而，TCP 传输并非不受安全风险的影响。提供了校验和验证，但它不能确保安全性，以防止中间设备同时更改有效载荷和校验和的故意篡改。这就是为什么开发 TLS/SSL 协议以增强数据安全性的原因，尽管它们可能会使典型情况下的问题分析变得复杂。

### 4.7.5 批处理和流水线

Paxos 是一种广泛使用的状态机复制协议，其性能可以通过批处理和流水线优化显著增强。然而，调整这些优化以获得最佳性能可能很复杂，因为它们的有效性受各种因素的影响，包括网络延迟和带宽、节点速度和应用程序属性。

下面是使用 BenchmarkSQL 进行 TPC-C 的 LAN 环境中的对比测试。有 1000 个仓库，并发从 50 到 2000。深蓝色代表没有批处理的吞吐量，而深红色代表有批处理的吞吐量。

<img src="media/image-20240829084512423.png" alt="image-20240829084512423" style="zoom:150%;" />

图 4-36. 批处理对 LAN 环境中 Paxos 算法性能的影响。

从图中可以清楚地看出，批处理在高并发下显著提高了吞吐量。在 LAN 环境中，流水线是否也有类似的效果？下图展示了在没有批处理的情况下进行的对比测试，以评估单独的流水线是否也能显著提升吞吐量。

<img src="media/image-20240829084537503.png" alt="image-20240829084537503" style="zoom:150%;" />

图 4-37. 流水线对 LAN 环境中 Paxos 算法性能的影响。

从图中可以清楚地看出，虽然流水线确实提高了 LAN 环境中的 TPC-C 吞吐量，但改进相对温和。有趣的是，在已启用批处理的 LAN 环境中，添加流水线几乎没有额外的好处，如下图所示。

<img src="media/image-20240829084610339.png" alt="image-20240829084610339" style="zoom:150%;" />

图 4-38. 流水线对 LAN 环境中批处理 Paxos 算法性能的影响。

流水线在 WAN 环境中的表现如何？让我们探讨其影响。下图显示了在不同流水线数量下 1000 个并发的吞吐量，网络延迟为 10ms，Paxos 算法启用批处理。

<img src="media/image-20240829084636349.png" alt="image-20240829084636349" style="zoom:150%;" />

图 4-39. 流水线对 WAN 环境中批处理 Paxos 算法性能的影响。

从图中可以清楚地看出，只有一个流水线时，吞吐量相对较低，为 60,051 tpmC。有十个流水线时，吞吐量显著增加到 476,783 tpmC。然而，将流水线增加到二十个与十个流水线相比差异很小。

让我们继续深入研究 WAN 环境中的批处理。下图显示了在禁用流水线和网络延迟为 10ms 的情况下，启用批处理前后 1000 个并发的吞吐量比较。

<img src="media/image-20240829084700560.png" alt="image-20240829084700560" style="zoom:150%;" />

图 4-40. 批处理对 WAN 环境中 Paxos 算法性能的影响。

从图中可以明显看出，在禁用流水线和批处理的情况下，吞吐量降至仅 2833 tpmC。这个数字反映了纯 Paxos 算法在 WAN 环境中的性能，吞吐量明显较低。

为什么纯 Paxos 在 WAN 环境中表现不佳？参考下图中的数据包捕获详细信息以获得见解。

![](media/484244432e5e53aff18ece6ad75eb616.png)

图 4-41. 从数据包捕获数据中了解纯 Paxos 协议。

图中清楚地显示，当流水线和批处理都被禁用时，这里称为纯 Paxos，吞吐量显著降至仅 2833 tpmC。纯 Paxos 的低吞吐量源于其串行交互性质，其中网络延迟主要决定吞吐量。

一般来说，流水线和批处理的测试结论与以下论文[48]中的结论一致：

![](media/73dfb3c0a76ecd9d6faa62c025ace5e4.gif)

图 4-42. 流水线和批处理对 Paxos 性能的影响。

### 4.7.6 网络延迟对性能的影响

网络延迟严重影响 MySQL 性能。在具有 1000 个仓库的 localhost 测试用例中，MySQL 实例绑定到 NUMA 节点 0、1 和 2，BenchmarkSQL 在 NUMA 节点 3 上，在并发级别为 50、100 和 150 的情况下检查延迟对吞吐量的影响。

<img src="media/image-20240829084730629.png" alt="image-20240829084730629" style="zoom:150%;" />

图 4-43. 网络延迟对性能的影响。

在 localhost 场景中进行测试可以显著减少网络延迟。从图中可以看出，减少网络延迟对 MySQL 吞吐量有明显影响，在 150 个并发时达到 800,000 tpmC。没有测试更高的并发，因为 MySQL 吞吐量在利用三个 NUMA 节点时接近其瓶颈。这个瓶颈会干扰评估网络延迟对吞吐量的影响。

### 4.7.7 网络分区

网络分区是一种网络故障，它将成员分成组，防止组之间的直接通信[45]。

网络分区可以分为三种主要类型[6]，如下图所示。

![](media/6d6657768e47e86b6522f6dd41a56ac2.png)

图 4-44. 网络分区类型。

该图将网络分区分为三种类型：

1. **完全网络分区（a）**：两个分区彼此完全断开，被广泛认为是完全网络分区。
2. **部分网络分区（b）**：组 1 和组 2 彼此断开，但组 3 仍然可以与两者通信。这被称为部分网络分区。
3. **单向网络分区（c）**：一个方向可以通信，但另一个方向不能，称为单向网络分区。

最复杂的类型是部分网络分区。部分分区将一组节点与集群中的一些节点（但不是全部）隔离，导致系统状态混乱，节点对服务器是否正常运行存在分歧。即使是专家开发人员也很少理解和测试这些分歧[6]。

对于像 Group Replication 这样的高可用性组件，测试极具挑战性。没有理论支持，人们甚至可能不会考虑网络分区有三种类型。第二种和第三种类型的场景通常是最有问题的，因为它们通常要么未经测试，要么未经彻底测试。网络很复杂，诊断问题，尤其是网络分区问题，可能特别具有挑战性。然而，背后有逻辑，解决网络分区问题通常需要收集信息和逻辑推理。

### 4.7.8 RDMA

远程直接内存访问（RDMA）使两台计算机之间的直接内存访问成为可能，而无需涉及操作系统、缓存或存储。与传统 IP 通信不同，RDMA 绕过内核干预，减少 CPU 开销。RDMA 协议允许主机适配器将网络数据包直接放入应用程序的内存空间，绕过内核处理和复制。这需要应用程序实现 InfiniBand Verbs API。

虽然 RDMA 显著减少了 TCP 处理延迟并在 LAN 场景中增加了 MySQL 吞吐量，但由于网络延迟，其在跨数据中心环境中的有效性有限。此外，修改 MySQL 的高成本限制了 RDMA 在实际用例中的采用。

### 4.7.9 数据包捕获信息的重要性

由于网络问题的复杂性以及软件专业人员缺乏有效的信息支持，存在持续的误判风险和陷入模糊问题陷阱的风险。为了有效解决 MySQL 相关的网络问题，可靠和准确的信息对于自信地朝着成功解决方案前进至关重要。掌握数据包捕获分析对于解决这些模糊的网络问题至关重要，并且通常可以在解决过程中发挥决定性作用。

要专门捕获 MySQL 交互的数据包，可以使用以下命令，假设 3306 是 MySQL 的监听端口：

```
tcpdump -i any tcp and port 3306 -s 250 -w mysql.pcap -v
```

有关更高级的功能，请参阅 *tcpdump* 文档以获取详细命令。虽然解决复杂的网络问题可能具有挑战性，但数据包捕获本身仍然相对简单。

### 4.7.10 网络问题中的逻辑推理

许多软件专业人员缺乏对 TCP/IP 逻辑推理的深入了解，这通常导致将问题误认为神秘问题。有些人被 TCP/IP 网络文献的复杂性所阻碍，而另一些人则被 Wireshark 中令人困惑的细节所误导。例如，面临性能问题的 DBA 可能会误解 Wireshark 中的数据包捕获数据，错误地得出 TCP 重传是原因的结论。

![](media/3a5d10caf25003e7ea4dcace59a181f6.gif)

图 4-45. DBA 提供的怀疑重传问题的数据包捕获截图。

由于怀疑重传，了解其性质至关重要。重传从根本上涉及超时重传。要确认重传是否确实是原因，需要与时间相关的信息，而上面的截图中没有提供。在请求 DBA 提供新截图后，包含了时间戳信息。

![](media/6670e70b6d5f0f5152f643c153d13487.png)

图 4-46. 添加了时间信息的数据包捕获截图。

在分析网络数据包时，时间戳信息对于准确的逻辑推理至关重要。两个重复数据包之间微秒范围内的时间差表明超时重传或重复数据包捕获。在典型的 LAN 环境中，往返时间（RTT）约为 100 微秒，其中 TCP 重传至少需要一个 RTT，仅在 RTT 的 1/100 处发生的重传可能表示重复数据包捕获而不是实际的超时重传。

另一个经典案例说明了逻辑推理在网络问题分析中的重要性。

有一天，一位业务开发人员匆忙赶来，说使用 MySQL 数据库中间件的定时脚本在凌晨失败，没有响应。听到这个问题后，我检查了 MySQL 数据库中间件的错误日志，但没有找到有价值的线索。因此，我问开发人员是否可以重现问题，知道一旦可以重现，问题就会变得更容易解决。

开发人员多次尝试重现问题，但未成功。然而，他们有了新发现：他们发现在白天执行相同的 SQL 查询与凌晨相比响应时间不同。他们怀疑当 SQL 响应缓慢时，MySQL 数据库中间件正在阻塞会话并且不向客户端返回结果。

基于这一见解，要求数据库运维团队修改脚本的 SQL 以模拟慢 SQL 响应。结果，MySQL 数据库中间件返回了结果，没有遇到凌晨看到的挂起问题。

有一段时间，无法确定根本原因，开发人员发现了 MySQL 数据库中间件的功能问题。因此，开发人员和 DBA 运维更加确信 MySQL 数据库中间件正在延迟响应。实际上，这些问题与 MySQL 数据库中间件的响应时间无关。

从第一天的事件来看，问题确实发生了。参与的每个人都试图找出原因，进行各种猜测，但真正的原因仍然难以捉摸。

第二天，开发人员报告说脚本问题在凌晨再次出现，但他们无法在白天重现它。开发人员感到压力，因为脚本很快就要在线使用，抱怨这种情况。我唯一的建议是让他们在白天使用脚本以避免凌晨的问题。由于所有怀疑都集中在 MySQL 数据库中间件上，因此从其他角度分析问题具有挑战性。

作为负责 MySQL 数据库中间件的开发人员，这样的神秘问题不能轻易忽视。忽视它们可能会影响 MySQL 数据库中间件的后续使用，领导层也有压力要求尽快解决问题。最后，决定实施低成本的数据包捕获分析解决方案：在凌晨执行脚本期间，将在服务器上执行数据包捕获以分析当时发生的情况。目标是确定 MySQL 数据库中间件是否根本没有发送响应，或者它确实发送了客户端脚本未收到的响应。一旦可以确认 MySQL 数据库中间件确实发送了响应，问题就不会归因于 MySQL 数据库中间件开发人员。

第三天，开发人员报告说凌晨问题没有再次发生，数据包捕获分析证实问题没有发生。经过仔细考虑，问题似乎不太可能仅与 MySQL 数据库中间件有关：凌晨频繁发生而白天很少发生令人困惑。唯一的行动方案是等待问题再次发生并根据数据包捕获进行分析。

第四天，问题没有再次出现。

然而，在第五天，问题终于再次出现，为解决带来了希望。

数据包捕获文件很多。首先，要求开发人员提供问题发生的时间戳，然后搜索大量数据包捕获数据以识别导致问题的 SQL 查询。最终结果如下：

![](media/4309ffee12d2eed2548845d1e1d2e848.png)

图 4-47. 为问题解决捕获的关键数据包信息。

从上面的数据包捕获内容（从服务器捕获）来看，SQL 查询在凌晨 3 点发送。MySQL 数据库中间件花费了 630 秒（03:10:30.899249-03:00:00.353157）将 SQL 响应返回给客户端，表明 MySQL 数据库中间件确实响应了 SQL 查询。然而，仅 238 微秒后（03:10:30.899487-03:10:30.899249），服务器的 TCP 层收到了一个重置数据包，这非常可疑。重要的是要注意，这个重置数据包不能立即假定来自客户端。

首先，有必要确认谁发送了重置数据包——要么是客户端发送的，要么是沿途的中间设备发送的。由于仅在服务器端执行了数据包捕获，因此没有关于客户端数据包情况的信息。通过分析服务器端的数据包捕获文件并应用逻辑推理，目标是找出问题的根本原因。

如果假设客户端发送了重置，这将意味着客户端的 TCP 层不再识别此连接的 TCP 状态——从已建立状态转换为不存在状态。TCP 状态的这种变化将通知客户端应用程序连接问题，导致客户端脚本立即出错。然而，实际上，客户端脚本仍在等待响应返回。因此，客户端发送重置的假设不成立——客户端没有发送重置。客户端的连接仍然活跃，但在服务器端，相应的连接已被重置终止。

那么谁发送了重置？主要嫌疑人是亚马逊的云环境。基于这次数据包捕获分析，DBA 运维查询了亚马逊客户服务并收到了以下信息：

![图片](media/5c6f81f69eac7f61744ba3bc035b29e7.png)

图 4-48. 亚马逊客户服务的最终响应。

客户服务的响应与分析结果一致，表明亚马逊的 ELB（弹性负载均衡器，类似于 LVS）强制终止了 TCP 会话。根据他们的反馈，如果响应超过 350 秒阈值（如数据包捕获中观察到的 630 秒），亚马逊的 ELB 设备会向响应方（在这种情况下是服务器）发送重置。开发人员部署的客户端脚本没有收到重置，错误地认为服务器连接仍然活跃。对于此类问题的官方建议包括使用 TCP 保活机制来缓解这些问题。

获得官方响应后，问题被认为完全解决了。

这个具体案例说明了在线问题可能高度复杂，需要捕获关键信息——在这种情况下是数据包捕获数据——以了解所发生的情况。通过逻辑推理和应用反证法，确定了根本原因。

[下一页](Chapter4_8_zh.md)
