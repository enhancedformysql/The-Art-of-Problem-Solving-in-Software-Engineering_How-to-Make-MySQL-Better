## 4.6 排队论

排队论是对等待队列的数学研究，用于预测队列长度和等待时间[45]。它在计算机科学和信息技术中得到广泛应用。例如，在网络中，路由器和交换机依赖队列来管理数据包传输。通过应用排队论，设计人员可以优化这些系统以实现响应性能和高效资源利用。虽然排队论并非专门设计用于提高软件性能，但它作为一种模型，通过检查物理和逻辑资源的利用方式来评估系统效率。根据排队论，几乎任何资源都可以被视为队列，瓶颈资源可以通过这种方式进行分析，以更好地理解其特性。

### 4.6.1 单队列瓶颈

下图描述了一个场景，其中 MySQL 主节点和 MySQL 从节点在 10ms 网络延迟下形成两节点集群。

![](media/4daa989affba4bd90fadec0d4236343a.png)

图 4-23. 使用改进的 Mencius 协议测试 Group Replication 的架构。

集群的 Paxos 算法采用改进的 Mencius 方法，去除了批处理和流水线，使其类似于纯 Paxos。在 10ms 网络延迟下进行了不同并发级别的测试，如下图所示：

<img src="media/image-20240830114557281.png" alt="image-20240830114557281" style="zoom:150%;" />

图 4-24. 使用改进的 Mencius 协议测试 Group Replication 的结果。

在 WAN 测试场景中，无论并发级别是 50、100 还是 150，吞吐量几乎保持恒定，因为 MySQL 处理 TPC-C 事务所需的时间与 10ms 的网络延迟相比可以忽略不计。网络延迟主导了整体事务时间，使得并发变化的影响相对不显著。

在这种场景下，吞吐量计算公式简化为：

![image-20240902000000001](media/image-20240902000000001.png)

这与上述测试结果非常接近，其中 0.45 是通过大量测试得出的经验因子，代表 tpmC 与 tpmTOTAL 的比率。测试表明，在 10ms 网络延迟且没有其他瓶颈的情况下，吞吐量在不同并发级别下保持一致。这种一致性是由于 Paxos 通信的串行特性，因为没有采用批处理和流水线。数据包捕获分析支持了这些发现。

![](media/484244432e5e53aff18ece6ad75eb616.png)

图 4-25. 从数据包捕获数据中了解改进的 Mencius 协议。

在图中，两个 Paxos 实例之间的网络延迟约为 10ms，与实际网络延迟完全匹配。大量实例表明 Paxos 通信本质上是串行的。在网络延迟是主导因素的场景中，它充当单队列瓶颈。因此，无论并发级别如何，改进的 Mencius 的吞吐量都受到这种网络延迟的限制。

### 4.6.2 多队列瓶颈

一个复杂的程序通常涉及多个队列，除非一个队列占主导地位，否则可能同时存在多个瓶颈。下图说明了一个基本的服务器队列模型，具有单个 CPU 和两个磁盘。当 CPU 繁忙时，请求被排队，访问磁盘时也会发生同样的情况。在这个模型中，可以应用排队论来计算服务器的吞吐能力。

![](media/fd2c7004f31d57eb9822307aac8afef9.png)

图 4-26. 具有单 CPU 和双磁盘的基本服务器队列模型。

在具有大量 CPU 和跨 NUMA 访问干扰的现代 NUMA 环境中，使用排队论直接计算系统吞吐量可能具有挑战性。例如，下图说明了 MySQL 5.7 的闩锁队列模型。

![](media/197c7662d3b25ebbc2870a1cee917e3f.png)

图 4-27. MySQL 5.7 中的闩锁队列模型。

这涉及 InnoDB 存储引擎内的闩锁队列瓶颈，这是 MySQL 5.7 中的一个重要的可扩展性问题。在这个队列模型中，仅解决单个瓶颈不足以解决可扩展性问题，准确评估这些队列瓶颈对吞吐量的影响仍然具有挑战性。

### 4.6.3 不同队列瓶颈之间的相互影响

下图是 NUMA 环境中多队列模型的简化示例。

![](media/7011ddacba948b383c12628c4f81c37f.png)

图 4-28. NUMA 环境中的多队列模型。

在 100 个并发线程的情况下，latch1 队列可以每秒处理 2,000 个请求。然而，在 500 个并发线程的情况下，其吞吐量降至每秒仅 200 个请求。这种差异是因为冲突增加导致大量上下文切换，导致缓存内容在 NUMA 节点间迁移，从而大幅降低内存访问效率。随着并发度的增加，这种低效率增长，导致吞吐量显著下降。

在正常条件下，100 个并发线程通过 latch1 后，通常有 10 个线程继续到 latch2，另外 10 个到 latch3。latch2 和 latch3 在 10 个并发线程的情况下都可以每秒处理 300 个请求，这意味着不会遇到瓶颈。

当 500 个并发线程与 latch1 交互时，冲突增加导致成功通过的请求减少，导致吞吐量降低。在识别并优化 latch1 后（如下图所示），其吞吐能力显著提高：现在可以在 500 个并发线程的情况下每秒处理 1,000 个请求。这种优化有效缓解了先前由 latch1 冲突引起的性能下降。

![](media/cfed8162c929bdf84a569ef649575563.png)

图 4-29. NUMA 环境中缓解 latch1 瓶颈的多队列模型。

当 500 个并发线程到达 latch1 队列时，改进的处理效率允许 50 个线程进入 latch2，另外 50 个进入 latch3。然而，latch2 和 latch3 的严重冲突将它们的处理能力分别降至每秒仅 25 和 30 个请求。这破坏了 latch2 和 latch3 队列的平衡，在优化 latch1 之前它们是稳定的。

在多队列瓶颈的场景中，优化一个瓶颈不一定会导致整体吞吐量的增加；甚至可能降低吞吐量。这种现象的实际例子包括配置文件引导优化（PGO）在高并发下导致吞吐量降低的情况。

让我们再次回顾应用 PGO 后高并发下的吞吐量情况：

<img src="media/image-20240829084258188.png" alt="image-20240829084258188" style="zoom:150%;" />

图 4-30. 在 MySQL 8.0.27 中使用 PGO 前后的性能对比测试。

配置文件引导优化（PGO）加速了 CPU 计算效率，使得更多线程在高并发下更早地进入闩锁队列。与优化前的状态相比，这加剧了闩锁冲突，导致吞吐量下降。有趣的是，当禁用 PGO 时，吞吐量在低并发下降低，但在高并发下增加。当多队列瓶颈共存时，这种反直觉的现象很常见。

让我们检查 redo log 优化前后的性能对比：

<img src="media/image-20240829084319943.png" alt="image-20240829084319943" style="zoom:150%;" />

图 4-31. MySQL 8.0 中 redo log 优化前后的性能对比测试。

图表显示，性能在低并发下得到改善，但在高并发下下降。这种反复测试的现象表明，并非所有优化都能立即显示效果；消除干扰对于观察真正的有效性至关重要。这些问题经常发生在 NUMA 环境中，因此缓解 NUMA 兼容性问题对于避免性能优化中的误判至关重要。开发人员对数据的依赖可能会忽略性能下降的真正原因，导致错过优化机会。

### 4.6.4 资源利用率与响应时间的关系

根据排队论，随着资源利用率的增加，平均响应时间也会增加，当利用率接近 100% 时，平均响应时间会急剧恶化。下图显示了使用 SysBench 对 CPU 资源进行的并发测试，显示了平均响应时间与 CPU 利用率之间的关系。最初，平均响应时间增长缓慢。然而，在 CPU 利用率约 60% 时，曲线急剧上升，在 96% 利用率时达到 13 毫秒以上。

<img src="media/image-20240829084347280.png" alt="image-20240829084347280" style="zoom:150%;" />

图 4-32. 平均响应时间与 CPU 利用率之间的关系。

如果资源耗尽，例如内存用完，机器的响应时间会变得非常慢。因此，控制资源利用率至关重要。根据排队论，对于 MySQL OLTP 系统，维持响应时间需要将利用率保持在一定范围内。找到最佳利用率点对于维持效率至关重要，这是事务节流理论的基础。虽然排队论不能直接解决问题，但它为性能优化提供了指导，并加深了对系统性能的理解。

### 4.6.5 事务节流机制

为了防止性能下降，控制资源使用至关重要。对于 MySQL OLTP 应用程序，管理进入事务系统的并发是关键，因为存在多个闩锁队列瓶颈和全局活动事务列表的复制。

MySQL 的实用事务节流机制如下：

1. 在进入事务系统之前，检查并发处理线程数是否超过限制。
2. 如果超过限制，阻塞用户线程，直到其他线程激活该线程。
3. 如果未超过限制，允许线程在事务系统内继续处理。
4. 事务完成后，激活等待队列中的第一个事务。

这种方法通过控制并发和有效管理资源使用来帮助维持性能。下图说明了在事务节流条件下 TPC-C 吞吐量与并发之间的关系，有 1000 个仓库。

<img src="media/image-20240829084425105.png" alt="image-20240829084425105" style="zoom:150%;" />

图 4-33. 使用事务节流机制的 BenchmarkSQL 中的最大 TPC-C 吞吐量。

从图中可以明显看出，实施事务节流机制显著提高了 MySQL 的可扩展性。

[下一页](Chapter4_7_zh.md)
