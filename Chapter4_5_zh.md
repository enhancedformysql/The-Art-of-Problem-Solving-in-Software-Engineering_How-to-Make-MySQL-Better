# 4.5 编译器理论

编译器理论是一门重要的计算机科学课程,涵盖了编译器构造的基本原理和方法。它包括语言和文法、词法分析、语法分析、语法制导翻译、中间代码生成、内存管理、代码优化和目标代码生成等主题。课程的核心是有限状态机。

## 4.5.1 有限状态机

有限状态机(FSM)是一个数学模型,用于表示系统内有限数量的状态、转换和动作。FSM 在各个领域都是必不可少的,例如编译器、网络协议和游戏引擎,它们描述复杂的系统、算法和事件响应。FSM 的核心概念是状态转换,它定义了不同状态之间的关系和动作。

在 MySQL 中,FSM 在词法和语法分析以及 Group Replication 中起着至关重要的作用。例如,在 Group Replication 中,FSM 帮助管理 Paxos 处理期间的决策,例如是继续处理还是在内存分配失败时退出并出错。通常,如果一个状态无法继续处理,它会退出并出错以防止拜占庭故障。

FSM 也用于 TCP/IP 协议中检测异常状态。例如,服务器端 TCP 连接上大量的 *CLOSE WAIT* 状态可能表明许多连接未正确关闭。

## 4.5.2 MySQL 解析器

MySQL 解析器用 C/C++ 实现,使用 GNU Bison 和 Flex 解析 SQL 查询。Flex 生成标记,而 Bison 处理语法解析。SQL 解析对于 MySQL 代理的读写评估和将 SQL 翻译成语法树等操作至关重要。

随着 CPU 核心数量的增加,MySQL 解析的 CPU 开销已经成为总体使用的较小比例。这种开销的减少可能解释了为什么 MySQL 8.0 删除了查询缓存。

## 4.5.3 PGO

配置文件引导优化(PGO)是一种编译器技术,通过使用来自插桩程序测试运行的分析数据来提高程序性能。PGO 不依赖于程序员提供的频率信息,而是利用配置文件数据来优化最终生成的代码,专注于程序中频繁执行的区域。这种方法减少了对启发式方法的依赖,并且可以提高性能,前提是分析数据准确地代表了典型的使用场景。

广泛的实践表明,MySQL 的大型代码库特别适合 PGO。然而,PGO 的有效性可能受到 I/O 存储设备和网络延迟的影响。在具有较慢 I/O 设备(如硬盘驱动器)的系统上,I/O 成为主要瓶颈,由于阿姆达尔定律,限制了 PGO 的性能增益。相比之下,在具有更快 I/O 设备(如 NVMe SSD)的系统上,PGO 可以带来显著的性能改进。网络延迟也会影响 PGO 的有效性,更高的延迟通常会降低好处。

总之,虽然 MySQL 8.0 的 PGO 功能可以极大地提高计算性能,但实际改进取决于服务器设置中计算和 I/O 瓶颈之间的平衡。下图表明,使用 NVMe SSD 硬件配置和 NUMA 绑定,PGO 可以显著提高 MySQL 的性能。

<img src="media/image-20240829083941927.png" alt="image-20240829083941927" style="zoom:150%;" />

图 4-22. SMP 下 MySQL 8.0.27 中使用 PGO 前后的性能比较测试。

[下一页](Chapter4_6_zh.md)
